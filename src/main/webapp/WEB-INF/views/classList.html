<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilates K :: Schedule</title>
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="/resources/css/common.css">
    <link rel="stylesheet" href="/resources/css/schedule.css">
    <link rel="stylesheet" href="/resources/css/home.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <!-- Flatpickr 스타일 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Flatpickr 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!--    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>-->

</head>
<body>

<script th:inline="javascript">
    /*<![CDATA[*/
    var msg = /*[[${msg}]]*/ '';  // 서버에서 전달된 메시지
    var status = /*[[${status}]]*/ '';  // 서버에서 전달된 상태(success, error)

    if (msg && msg.trim() !== '') {
        // 상태에 따른 아이콘 설정
        var iconType = status === 'success' ? 'success' : (status === 'error' ? 'error' : 'info');

        Swal.fire({
            title: '알림',
            text: msg,
            icon: iconType,
            confirmButtonText: '확인'
        });
    }
    /*]]>*/
</script>
<!-- Bootstrap 5 JS 및 Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

<div th:replace="layout/header"></div>
<div class="container mt-2">

    <div class="title">레슨 찾기</div>
    <p>예약할 날짜 / 시간대의 레슨을 선택하여 예약해주세요.</p>
    <p>날짜 : <strong id="current-date" th:text="${startDate}"></strong></p>

    <p><strong>타임테이블로 예약하기</strong></p>

    <div class="table-navigation">
        <button id="previous-btn" onclick="goToPrevious5Days()">&lt; 이전 5일 보기</button>
        <button id="next-btn">다음 5일 보기 &gt;</button>
        <input type="hidden" id="currentStartDate" th:value="${startDate}">
    </div>

    <table class="schedule-table" id="schedule-table">
        <thead>
        <tr>
            <th>시작시간</th>
            <!-- 날짜별 헤더 생성 -->
            <th th:each="date : ${formattedDates}" th:text="${date}"></th>
        </tr>
        </thead>
        <tbody>
        <!-- 시간 기준으로 행을 만듦 -->
        <tr th:each="time : ${times}">
            <td th:text="${time}"></td>
            <!-- 날짜별로 해당 시간의 수업 정보 표시 -->
            <td th:each="date : ${formattedDates}">
                <span th:each="class : ${scheduleMap.get(time).get(date)}">
                    <div th:text="${class.class_name}" class="fw-bold"></div>
                    <div th:if="${reservedClassIds.contains(class.id)}">
                        <span class="badge bg-success mb-1">예약중</span>

                        <button type="button"
                                class="btn btn-danger btn-sm open-cancel-modal"
                                data-bs-toggle="modal"
                                data-bs-target="#reserveModal"
                                th:attr="data-class-id=${class.id},
                                         data-class-type-name=${class.class_type_name},
                                         data-class-name=${class.class_name},
                                         data-class-instructor-name=${class.instructor_name},
                                         data-class-start-time=${class.class_start_time},
                                         data-class-end-time=${class.class_end_time},
                                         data-class-date=${class.class_date}">
                            예약 취소
                        </button>
                    </div>

                    <!-- 예약이 안되어있을 경우 예약 버튼만 표시 -->
                    <button type="button"
                            th:unless="${reservedClassIds.contains(class.id)}"
                            class="btn btn-primary btn-sm mt-1 open-reserve-modal"
                            data-bs-toggle="modal"
                            data-bs-target="#reserveModal"
                            th:attr="data-class-id=${class.id},
                                     data-class-type-name=${class.class_type_name},
                                     data-class-name=${class.class_name},
                                     data-class-instructor-name=${class.instructor_name},
                                     data-class-start-time=${class.class_start_time},
                                     data-class-end-time=${class.class_end_time},
                                     data-class-date=${class.class_date}">
                        예약하기
                    </button>

                </span>

                <span th:if="${scheduleMap.get(time) == null or scheduleMap.get(time).get(date) == null or #lists.isEmpty(scheduleMap.get(time).get(date))}">
                    수업 없음
                </span>
            </td>
        </tr>
        </tbody>
    </table>


    <form id="searchForm" th:action="@{/class/list}" method="get" >

        <div>
            <p><strong>날짜/수업으로 검색하여 예약하기</strong></p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="searchClassDate">수업 날짜</label>
                <input type="text" id="searchClassDate" name="searchClassDate" class="flatpickr-input" placeholder="-- 날짜를 선택하세요 --"
                       th:value="${selectedDate}">
            </div>
            <div class="form-group">
                <label class="form-label" for="className">수업명</label>
                <select id="className" name="searchClassName">
                    <option class="placeholder-option_th" value="">-- 수업을 선택하세요 --</option>
                    <option class="placeholder-option_tk" th:each="c : ${classNames}"
                            th:value="${c}"
                            th:text="${c}"
                            th:selected="${c == selectedClassName}">
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="instructor">강사명</label>
                <select id="instructor" name="searchInstructor">
                    <option class="placeholder-option_th" value="">-- 강사를 선택하세요 --</option>
                    <option class="placeholder-option_tk" th:each="c : ${instructors}"
                            th:value="${c}"
                            th:text="${c}"
                            th:selected="${c == selectedInstructor}">
                    </option>
                </select>
            </div>
        </div>

            <div class="button-container mt-2">
                <button type="submit">해당 조건으로 검색하기</button>
            </div>

        <div id="searchResultTables">
        <div th:each="entry : ${groupedClassMap}" >
            <table class="search-table" th:attr="data-date=${entry.key}">
                <thead>
                <tr>
                    <th class="entry-header" colspan="4" th:text="${entry.key}"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="classmap : ${entry.value}">
                    <td>
                        <span th:text="${classmap.class_date}"></span> <br>
                        <span th:text="${classmap.class_start_time}"></span> -
                        <span th:text="${classmap.class_end_time}"></span> <br>
                        <span th:text="${classmap.instructor_name}"></span> <br>
                        <span th:text="${classmap.class_point_name}"></span>
                    </td>
                    <td class="lesson-title" th:text="${classmap.class_name}"></td>
                    <td th:text="${classmap.class_type_name}"></td>
                    <td>
                        <div th:if="${reservedClassIds.contains(classmap.id)}">
                            <span class="badge bg-success mb-1">예약중</span>
                            <button type="button"
                                    class="btn btn-danger btn-sm open-cancel-modal"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reserveModal"
                                    th:attr="data-class-id=${classmap.id},
                                         data-class-type-name=${classmap.class_type_name},
                                         data-class-name=${classmap.class_name},
                                         data-class-instructor-name=${classmap.instructor_name},
                                         data-class-start-time=${classmap.class_start_time},
                                         data-class-end-time=${classmap.class_end_time},
                                         data-class-date=${classmap.class_date}">
                                예약 취소
                            </button>
                        </div>

                        <button type="button"
                                th:unless="${reservedClassIds.contains(classmap.id)}"
                                class="btn btn-primary btn-sm mt-1 open-reserve-modal"
                                data-bs-toggle="modal"
                                data-bs-target="#reserveModal"
                                th:attr="data-class-id=${classmap.id},
                                     data-class-type-name=${classmap.class_type_name},
                                     data-class-name=${classmap.class_name},
                                     data-class-instructor-name=${classmap.instructor_name},
                                     data-class-start-time=${classmap.class_start_time},
                                     data-class-end-time=${classmap.class_end_time},
                                     data-class-date=${classmap.class_date}">
                            예약하기
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        </div>
    </form>

    <div class="text-center mt-3" th:if="${hasMore}">
        <button id="loadMoreBtn" class="btn btn-primary" type="button">레슨이력 더보기</button>
    </div>

</div>
<!-- 예약 모달 -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="reserveModalLabel">수업 예약하기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p><strong>Date : </strong> <span id="modalClassDate"></span></p>
                <p><strong>Time : </strong>
                    <span id="modalClassStartTime"></span> - <span id="modalClassEndTime"></span>
                </p>
                <p><strong>Class Type : </strong> <span id="modalClassTypeName"></span></p>
                <p><strong>Class Name : </strong> <span id="modalClassName"></span></p>
                <p><strong>Instructor : </strong> <span id="modalClassInstructor"></span></p>
            </div>

            <form id="reserveForm" action="/reservation/add" method="post">
                <input type="hidden" name="class_id" id="modalClassId" />

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>

                    <!-- 예약 확정 버튼 -->
                    <button type="submit" id="confirmReserveBtn" class="btn btn-primary">예약 확정</button>

                    <!-- 취소 확정 버튼 (초기에는 숨겨둠) -->
                    <button type="button" id="confirmCancelBtn" class="btn btn-danger" style="display: none;">예약 취소 확정</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div th:replace="layout/footer"></div>
<script src="/resources/js/class-reservate.js"></script>
<script src="/resources/js/class-date-selecter.js"></script>
<script>
    flatpickr("#searchClassDate", {
        dateFormat: "Y-m-d", // yyyy-mm-dd
        locale: "ko" // 한글 적용
    });
</script>

<script th:if="${searchExecuted}">
    window.addEventListener('load', function () {
        const result = document.getElementById("searchForm");
        if (result) {
            result.scrollIntoView({ behavior: "smooth" });
        }
    });
</script>

<script>
    let offset = 10;

    document.getElementById('loadMoreBtn')?.addEventListener('click', function () {
        const params = new URLSearchParams({
            offset: offset,
            size: 10,
            searchClassDate: document.getElementById('searchClassDate')?.value || '',
            searchClassName: document.getElementById('className')?.value || '',
            searchInstructor: document.getElementById('instructor')?.value || ''
        });

        fetch(`/class/list/more?${params.toString()}`)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                const list = data.reservedClass;
                const reservedClassIds = data.reservedClassIds;
                const hasMore = data.hasMore;

                if (!list || Object.keys(list).length === 0) return;

                Object.entries(list).forEach(([date, classList]) => {
                    const tableSelector = `table[data-date="${CSS.escape(date)}"]`;
                    const container = document.getElementById('searchResultTables');

                    let existingTable = document.querySelector(tableSelector);
                    let tbody;

                    if (!existingTable) {
                        // 새 날짜 테이블 생성
                        const newTable = document.createElement('table');
                        newTable.className = 'search-table';
                        newTable.setAttribute('data-date', date);

                        newTable.innerHTML = `
                        <thead>
                            <tr>
                                <th class="entry-header" colspan="4">${date}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;

                        container.appendChild(newTable);
                        existingTable = newTable;
                    }

                    tbody = existingTable.querySelector('tbody');

                    classList.forEach(classmap => {
                        const isReserved = reservedClassIds.includes(classmap.id);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>
                            ${classmap.class_date}<br>
                            ${classmap.class_start_time} - ${classmap.class_end_time}<br>
                            ${classmap.instructor_name}<br>
                            ${classmap.class_point_name}
                        </td>
                        <td class="lesson-title">${classmap.class_name}</td>
                        <td>${classmap.class_type_name}</td>
                        <td>
                            ${isReserved ? `
                                <span class="badge bg-success mb-1">예약중</span>
                                <button type="button"
                                    class="btn btn-danger btn-sm open-cancel-modal"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reserveModal"
                                    data-class-id="${classmap.id}"
                                    data-class-type-name="${classmap.class_type_name}"
                                    data-class-name="${classmap.class_name}"
                                    data-class-instructor-name="${classmap.instructor_name}"
                                    data-class-start-time="${classmap.class_start_time}"
                                    data-class-end-time="${classmap.class_end_time}"
                                    data-class-date="${classmap.class_date}">
                                    예약 취소
                                </button>
                            ` : `
                                <button type="button"
                                    class="btn btn-primary btn-sm mt-1 open-reserve-modal"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reserveModal"
                                    data-class-id="${classmap.id}"
                                    data-class-type-name="${classmap.class_type_name}"
                                    data-class-name="${classmap.class_name}"
                                    data-class-instructor-name="${classmap.instructor_name}"
                                    data-class-start-time="${classmap.class_start_time}"
                                    data-class-end-time="${classmap.class_end_time}"
                                    data-class-date="${classmap.class_date}">
                                    예약하기
                                </button>
                            `}
                        </td>
                    `;
                        tbody.appendChild(row); // ✅ 제대로 된 위치에 추가
                    });
                });

                offset += 10;
                if (!hasMore) {
                    document.getElementById('loadMoreBtn').style.display = 'none';
                }
            })
            .catch(error => {
                console.error("더보기 요청 중 에러 발생:", error);
                alert("수업 더보기 중 오류가 발생했습니다. 콘솔을 확인해주세요.");
            });
    });

</script>
</body>
</html>
